# 第3章 STM32F1系列微控制器

## 3.1 简介

Cortex-M3 系列微处理器特点

- Thumb-2 指令集架构(ISA)的子集
- 哈佛处理器架构，在加载/存储数据的同时能够执行指令取指
- 三级流水线
- 32 位单周期乘法
- 具备硬件除法
- Thumb 状态和调试状态
- 处理模式和线程模式
- ISR 的低延迟进入和退出
- 可中断-可继续的LDM/STM，PUSH/POP
- ARMv6类型BE8/LE支持
- ARMv6 非对齐访问
- 分支预测功能

**命名规则**

<img src="./Images/第3章 STM32F1系列微控制器/图 3.1.png" alt="图 3.1" style="zoom:50%;" />

**产品架构**

<img src="./Images/第3章 STM32F1系列微控制器/图 3.2.png" alt="图 3.2" style="zoom:50%;" />

- Cortex-M3内核DCode 总线(D-bus)和系统总线(S-bus)
- 通用 DMA1 和通用 DMA2
- 内部 SRAM.
- 内部闪存存储器
- FSMC
- AHB到APB的桥(AHB2APBx),它连接所有的APB设备

**总线**

- **ICode 总线**:该总线将Cortex-M3内核的**指令总线**与**闪存指令接口**相连接。**指令预取**在此总线上完成。
- **DCode总线**:该总线将Cortex-M3内核的**DCode 总线**与**闪存存储器**的数据接口相连接(常量加载和调试访问)。
- **系统总线**:此总线连接Cortex-M3内核的**系统总线(外设总线)**到**总线矩阵**,总线矩阵协调着内核和DMA间的访问。
- **DMA总线**:此总线将**DMA的AHB主控接口**与**总线矩阵**相连,总线矩阵协调着CPU的DCode和DMA到SRAM、闪存和外设的访问。
- **总线矩阵**:总线矩阵协调内核系统总线和DMA主控总线之间的访问仲裁,仲裁采用轮换算法。总线矩阵包含**4个主动部件**(CPU的DCode、系统总线、DMA1总线和DMA2总线)和**4个被动部件**(闪存存储器接口、SRAM、FSMC和AHB2APB桥)。
- **AHB/APB桥(APB)**:两个AHB/APB桥在AHB和两个APB总线间提供同步连接，APB1操作速度限于36MHz,APB2操作于全速(最高72MHz)。

AHB外设通过总线矩阵与系统总线相连,允许DMA访问。

上述模块由**AMBA(Advanced Microcontroller Bus Architecture)**总线连接到一起。它包括**AHB(Advanced High performance Bus)**和 **APB(Advanced Peripheral Bus)**,前者作为系统总线,后者作为外设总线。

**内部架构**

<img src="./Images/第3章 STM32F1系列微控制器/图 3.3.png" alt="图 3.3" style="zoom:43%;" />

**引脚**

<img src="./Images/第3章 STM32F1系列微控制器/图 3.4.png" alt="图 3.4" style="zoom:50%;" />

**存储器映像**

<img src="./Images/第3章 STM32F1系列微控制器/图 3.5.png" alt="图 3.5" style="zoom:50%;" />

**时钟结构**

<img src="./Images/第3章 STM32F1系列微控制器/图 3.6.png" alt="图 3.6" style="zoom:50%;" />

STM32系列微控制器中,有5个时钟源,分别是**高速内部时钟(HighSpeed Internal,HSI)、高速外部时钟(High Speed External,HSE)、低速内部时钟(Low Speed Internal,LSI)低速外部时钟(Low Speed External,LSE)、锁相环倍频输出(Phase Locked Loop,PLL)。**

STM32F103ZET6具有多个时钟频率,分别供给内核和不同外设模块使用。高速时钟供**中央处理器**等高速设备使用,低速时钟供**外设**等低速设备使用。HSI、HSE或PLL可被用来驱动系统时钟(SYSCLK)。

LSI、LSE作为**二级时钟源**。40kHz低速内部RC时钟可以用于驱动独立看门狗和通过程序选择驱动RTC。RTC用于从停机/待机模式下自动唤醒系统。当某个部件不被使用时,任一个时钟源都可被独立地启动或关闭,由此优化系统功耗

用户可通过多个预分频器配置AHB、高速APB(APB2)和低速APB(APB1)的频率。AHB和APB2的最大频率是**72MHz**。APB1的最大允许频率是**36MHz**。SDIO接口的时钟频率固定为HCLK/2。

STM32处理器因为低功耗的需要,各模块需要分别独立开启时钟。因此,当需要使用某个外设模块时,**务必要先使能对应的时钟**。否则,这个外设不能工作。

**时钟复杂的原因**：高速时钟供中央处理器等高速设备使用，低速时钟供外设等低速设备使用；时钟分开有助于实现低功耗。

**启动配置引脚**

<img src="./Images/第3章 STM32F1系列微控制器/图 3.7.png" alt="图 3.7" style="zoom:50%;" />

- **从主闪存存储器启动**:主闪存存储器被映射到启动空间`(0x00000000)`,但仍然能够在它原有的地址(`0x08000000`)访问它,即闪存存储器的内容可以在两个地址区域访间,`0x00000000`或`0x08000000`。
- **从系统存储器启动**:系统存储器被映射到启动空间(`0x00000000`),但仍然能够在它原有的地址(互联型产品原有地址为`0x1FFFB000`,其他产品原有地址为`x1FFFF000`)访问它。
- **从内置SRAM启动**:只能在`0x20000000`开始的地址区访问SRAM。从内置SRAM启动时,在应用程序的初始化代码中,必须使用NVIC的异常表和偏移寄存器,重新映射向量表到SRAM中。

## 3.2 最小系统

不写了，感觉没必要。开第四章。